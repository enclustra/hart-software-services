# Polarfire SoC Hart Software Services

This repository is a fork of the [Polarfire SoC HSS](https://github.com/polarfire-soc/hart-software-services) repository of Microchip and adds support for Enclustra Mercury+ MP1 product series.
The original documentation of the HSS software can be found [here](https://github.com/polarfire-soc/hart-software-services/blob/master/README.md).

## Maintainer 

Enclustra GmbH [[support@enclustra.com](mailto:support@enclustra.com)]

## License

See [License](LICENSE.md)

## Changelog

| Date       | Version | Comment               |
|------------|---------|-----------------------|
| 26.07.2022 | 2021.11 | First version         |
| 10.11.2022 | 2022.09 | Memory layout changed |

## Modifications for Mercury+ MP1 product series

### Support for Mercury+ MP1 product series

Following product models are supported:

- ME-MP1-250-EES-D3E
- ME-MP1-250-EES-D3E-E1
- ME-MP1-250-SI-D3EN
- ME-MP1-250-SI-D3EN-E1
- ME-MP1-460-1SI-D4E
- ME-MP1-460-1SI-D4E-E1

### Ethernet PHY configuration

At power up, the Ethernet PHYs located on the Mercury+ MP1 module are in power-down mode. The HSS reconfigures the INT#/PWDN# pin of the DP83867IS Ethernet PHY for interrupt functionality and releases the PHYs from power-down mode. 

### DDR memory initialisation

The provided MSS configuration enables ECC functionality for the MSS DDR memory. The entire DDR memory is initialized with zeroes to prevent from ECC errors. DDR memory initialisation increases boot time for about 25 seconds.

### Peripheral reset

Pin 12 of MSS bank 4 controls the reset signal of following peripherals:
- Ethernet PHY
- USB PHY
- QSPI flash

The reset is deasserted at boot time to enable the above mentioned peripherals.

### Control of UART multiplexer

The Enclustra Mercury+ module pinout defines only one UART interface. The HSS software running on hart 0 uses UART 0 and Linux or baremetal software running on hart1-4 might use one of the other 4 UART peripherals. To allow access for UART 1, the reference design contains a UART multiplexer in the FPGA fabric to switch between UART 0 and UART 1. Before the HSS software boots the payload, the UART multiplexer is configured to route UART 1 to the module pins.

## MSS configuration

The MSS configuration generated by the MSS configurator tool can be found in [boards/enclustra-mercury-mp1/soc_fpga_design/config](boards/enclustra-mercury-mp1/soc_fpga_design/config) directory. One configuration file for each product variant is available. The exported xml file is stored in [boards/enclustra-mercury-mp1/soc_fpga_design/xml](boards/enclustra-mercury-mp1/soc_fpga_design/xml) directory. The provided MSS configuration was exported from the reference design [Mercury_MP1_PE1_Reference_Design](https://github.com/enclustra/Mercury_MP1_PE1_Reference_Design). When the MSS configuration is updated, the existing xml file needs to be replaced with the new generated one.

# Build

To build the HSS binary, SoftConsole 2022.2 and Libero 2022.2 is required to be installed on the host computer.

## Build on Windows host

1. Clone this git repository

2. Open SoftConsole and create a new workspace

3. Import the source files

    - Open the import dialog in **File** -> **Import...**
    - Select **Existing Projects into Workspace** and click **Next >**
    - Enable **Select root directory**, enter the path of the cloned repository and click **Finish**

5. Configure the project

    - Copy one of the configuration files in **\<workspace\>/hart-software-services/board/enclustra-mercury-mp1/** directory to the root directory (**\<workspace\>/hart-software-services/**) and rename the file to **.config**:
        - me-mp1-250-ees-d3e_config (for **ME-MP1-250-EES-D3E** and **ME-MP1-250-EES-D3E-E1**)
        - me-mp1-250-si-d3en_config (for **ME-MP1-250-SI-D3EN** and **ME-MP1-250-SI-D3EN-E1**)
        - me-mp1-460-1si-d4e_config (for **ME-MP1-460-1SI-D4E** and **ME-MP1-460-1SI-D4E-E1**)
    - Select the **hart-software-services** project in the Project Explorer and open the project properties (**File** -> **Properties**)
    - Open **C/C++ Build** -> **Environment** tab and add following variable:
        - Name: **BOARD**
        - Value: **enclustra-mercury-mp1**

6. To build the project, hit **CTRL + B**.

## Build on Linux host

1. Prepare environment

    - Export the installation directory of SoftConsole
    ```
    export SC_INSTALL_DIR=~/Microchip/SoftConsole-v2022.2-RISC-V-747
    ```
    - Append python and toolchain directory to the PATH variable
    ```
    export PATH=$PATH:$SC_INSTALL_DIR/python/bin:$SC_INSTALL_DIR/riscv-unknown-elf-gcc/bin
    ```
    - Export the path to fpgenprog tool
    ```
    export FPGENPROG=~/Microchip/Libero_SoC_v2022.2/Libero/bin64/fpgenprog
    ```

3. Open a terminal, clone this git repository and change to the directory of the repository

```
git clone git@github.com:enclustra/hart-software-services.git
cd hart-software-services
```

4. Copy the configuration file of the correct product variant to the root directory of the repository and rename the file to ".config"

```
cp boards/enclustra-mercury-mp1/me-mp1-250-ees-d3e_config .config
```

5. Build the design

```
make BOARD=enclustra-mercury-mp1
```

## Deployment

### Embed HSS binary into bitstream in Libero

The generated file **Default/bootmode1/hss-envm-wrapper-bm1-p0.hex** can be added in Libero as boot mode 1 client to the eNVM memory before the bitstream is created.

1. In **Design Flow** window, open **Configure Design Initialization Data and Memories**
2. Select **eNVM** tab
3. Add **Boot Mode 1 Client** and select the **hss-envm-wrapper-bm1-p0.hex** file
4. Click on **Apply** button to save the changes
5. Generate the Bitstream
6. Configure the hardware with the new bitstream

### Program eNVM memory in SoftConsole

The HSS binary in the eNVM memory can be programmed in SoftConsole, including change of the boot mode to 1. Make sure a JTAG programmer is attached to the hardware and the hardware is powered on. 

1. In SoftConsole, click on **Run** -> **External Tools** -> **2 Polarfire SoC program non-secure boot mode 1**
